name: gaga-blog

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æ‹‰å–ä»£ç 
      uses: actions/checkout@v3

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ”§ æ„å»º VitePress
      run: npm run docs:build

    - name: ğŸ—‚ï¸ æ‹·è´æ„å»ºå†…å®¹åˆ° deploy æ–‡ä»¶å¤¹
      run: |
        mkdir deploy
        cp -r .vitepress/dist/* deploy/

    - name: ğŸ”¥ æ¸…ç©ºæœåŠ¡å™¨æ—§å†…å®¹
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: rm -rf /home/html/gaga-blog/*

    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºæ–‡ä»¶åˆ°æœåŠ¡å™¨
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        source: "./deploy/**"                 # ä½¿ç”¨åŒæ˜Ÿå·é€’å½’ä¸Šä¼ 
        target: "/home/html/gaga-blog/"
        strip_components: 1                   # âœ… å…³é”®ï¼šå»æ‰ deploy ç›®å½•ç»“æ„

    - name: â™»ï¸ é‡å¯ Nginx
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: sudo systemctl restart nginx
